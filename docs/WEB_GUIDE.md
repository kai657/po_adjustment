# PO清单分箱优化系统 - Web版使用指南

## 快速启动

### 1. 启动Web应用

**方式一：使用启动脚本（推荐）**
```bash
./start_web.sh
```

**方式二：直接运行**
```bash
python3 app.py
```

### 2. 访问Web界面

启动后，在浏览器中打开：
```
http://localhost:5001
```

## 使用流程

### 步骤1: 上传文件 📂

1. **上传排程目标文件**
   - 点击"选择文件"按钮
   - 选择 `shechle_aim.xlsx` 或你的排程目标文件
   - 文件应包含列: 日期, week_num, SKU, 计划产量

2. **上传PO清单文件**
   - 点击"选择文件"按钮
   - 选择 `po_lists.xlsx` 或你的PO清单文件
   - 文件应包含列: SKU, 数量, 修改要货日期, week_num, PO-PO行-发运行号

3. **点击"上传并预览"**
   - 系统会验证文件格式
   - 显示数据概览信息
   - 自动进入下一步

### 步骤2: 参数设置 ⚙️

调整优化算法参数：

#### 1. 优先保障周数
- **默认值**: 8周（2个月）
- **说明**: 前N周的偏差最小化优先级更高
- **建议**: 根据业务需求设置，通常为6-12周

#### 2. 优先周权重
- **默认值**: 10倍
- **说明**: 前N周偏差的权重倍数
- **建议**: 值越大，前N周越准确，但可能影响后续周次

#### 3. 日期接近度权重
- **默认值**: 0.01
- **说明**: 调整后日期与原日期接近程度的权重
- **建议**: 0.01-0.1之间，值越大越倾向于保持原日期

#### 4. 并行进程数
- **默认值**: 4个
- **说明**: 同时处理的SKU数量
- **建议**: 根据CPU核心数设置，通常为2-8

### 步骤3: 执行优化 🚀

1. **确认参数配置**
   - 检查参数摘要表
   - 确保各项参数符合预期

2. **点击"开始优化"**
   - 系统开始执行优化算法
   - 显示实时进度条
   - 等待优化完成（通常1-5分钟）

### 步骤4: 查看结果 📊

优化完成后，系统会展示：

#### 1. 优化效果汇总
- 处理的SKU数量
- 原始总偏差
- 优化后总偏差
- 改善率百分比

#### 2. 可视化图表
- **每周数量对比图**: 展示排程目标 vs 原始PO vs 优化后PO
- **偏差改善对比图**: 展示每周偏差的改善情况

#### 3. 下载结果文件
- 📄 优化后PO清单 - 可直接使用的调整后清单
- 📊 详细对比报告 - Excel格式，包含详细数据
- 📈 数量对比图 - PNG格式
- 📉 偏差对比图 - PNG格式

## 技术特性

### 优化算法
- **策略**: 贪心算法 + 加权偏差最小化
- **约束条件**:
  - 日期范围: 2025-10-01 至 2026-06-01
  - 要货日期必须为周一
  - 自动排除中国法定节假日

### 性能优化
- 按SKU并行处理
- 支持多进程加速
- 自动内存管理

### 数据安全
- 文件仅在服务器端临时存储
- 结果文件带时间戳，避免覆盖
- 支持随时重新开始

## 常见问题

### Q1: 上传文件失败？
**A**: 检查以下几点：
- 文件格式必须是 `.xlsx` 或 `.xls`
- 文件大小不超过 16MB
- 确保文件包含必需的列
- 检查日期格式是否正确

### Q2: 优化时间过长？
**A**: 可能的原因和解决方法：
- SKU数量较多：增加并行进程数
- 单个SKU的PO订单很多：正常现象，耐心等待
- 服务器资源不足：减少并行进程数

### Q3: 优化效果不理想？
**A**: 调整参数：
- 增加优先周权重，提高前N周准确性
- 调整优先保障周数
- 检查排程目标是否合理

### Q4: 如何解读改善率？
**A**: 改善率说明：
- 改善率 > 0%：优化有效，偏差减少
- 改善率 = 0%：原始PO已经最优，或该SKU无可优化空间
- 改善率 < 0%：理论上不应出现，请检查数据

### Q5: 端口被占用怎么办？
**A**: 修改 `app.py` 最后一行的端口号：
```python
app.run(debug=True, host='0.0.0.0', port=5002)  # 改为其他端口
```

## 文件结构

```
工单调整工具/
├── app.py                    # Flask后端应用
├── po_optimization.py        # 优化算法核心
├── visualization.py          # 可视化生成
├── start_web.sh             # 启动脚本
├── templates/               # HTML模板
│   └── index.html          # 主页面
├── static/                  # 静态资源
│   ├── css/
│   │   └── style.css       # 样式表
│   └── js/
│       └── app.js          # 前端交互
├── uploads/                 # 上传文件目录（自动创建）
└── results/                 # 结果文件目录（自动创建）
```

## API接口文档

### 1. 上传文件
```
POST /api/upload
Content-Type: multipart/form-data

参数:
- schedule_aim: 排程目标文件
- po_lists: PO清单文件

返回:
{
  "success": true,
  "message": "文件上传成功",
  "data": {
    "schedule_aim": {...},
    "po_lists": {...}
  }
}
```

### 2. 执行优化
```
POST /api/optimize
Content-Type: application/json

参数:
{
  "priority_weeks": 8,
  "priority_weight": 10.0,
  "date_weight": 0.01,
  "max_workers": 4
}

返回:
{
  "success": true,
  "message": "优化完成",
  "data": {
    "timestamp": "20251216_123456",
    "summary": [...],
    "files": {...}
  }
}
```

### 3. 下载文件
```
GET /api/download/<filename>

返回: 文件流
```

### 4. 预览图片
```
GET /api/preview/<filename>

返回: 图片流
```

### 5. 系统状态
```
GET /api/status

返回:
{
  "success": true,
  "data": {
    "schedule_uploaded": false,
    "po_uploaded": false,
    "upload_folder": "uploads",
    "result_folder": "results"
  }
}
```

## 浏览器支持

推荐使用以下浏览器的最新版本：
- Google Chrome
- Microsoft Edge
- Mozilla Firefox
- Safari

## 系统要求

- Python 3.7+
- 2GB+ RAM
- 多核CPU（推荐）
- 现代浏览器

## 故障排查

### 问题: 页面无法加载
1. 检查Flask应用是否正常运行
2. 检查端口5001是否被占用
3. 查看终端错误信息

### 问题: 文件上传失败
1. 检查文件大小（最大16MB）
2. 确认文件格式为xlsx或xls
3. 查看浏览器控制台错误

### 问题: 优化失败
1. 检查上传文件的数据格式
2. 确认日期列为日期类型
3. 查看Flask终端的错误日志

## 技术支持

如遇问题：
1. 查看终端输出的错误信息
2. 检查浏览器开发者工具的控制台
3. 参考本文档的常见问题部分

## 更新日志

### v1.0.0 (2025-12-16)
- 初始版本发布
- 支持文件上传和参数配置
- 实现优化算法和可视化
- 提供完整的Web界面

---

祝使用愉快！如有建议，欢迎反馈。
