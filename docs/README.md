# PO清单分箱优化工具

## 功能概述

本工具基于排程目标自动调整PO清单的要货日期，使得每个SKU在每周的数量与目标的绝对偏差之和最小。

## 核心特性

- **智能优化**: 基于贪心算法，逐个分配PO订单到最优周次
- **多重约束**:
  - 要货日期范围: 2025-10-01 至 2026-06-01
  - 要货日期必须为周一
  - 自动排除中国法定节假日
- **优先策略**: 优先保障前2个月（8周）的数量准确性，前8周的偏差权重为10倍
- **次要目标**: 在满足偏差最小的前提下，调整后日期尽量接近供应商可验货日期
- **并行处理**: 按SKU并行执行优化，提升计算效率
- **可视化对比**: 自动生成图表和报告，直观展示优化效果

## 文件说明

### 输入文件

1. **shechle_aim.xlsx** - 排程目标文件
   - 列: 日期, week_num, SKU, 计划产量
   - 描述: 每个SKU在每周的计划产量目标

2. **po_lists.xlsx** - PO清单文件
   - 列: SKU, 数量, 修改要货日期, week_num, PO-PO行-发运行号
   - 描述: 原始PO订单清单，需要调整要货日期

### 输出文件

1. **po_lists_optimized.xlsx** - 优化后的PO清单
   - 与输入格式相同，但要货日期已调整为最优日期

2. **comparison_report.xlsx** - 详细对比报告
   - Sheet 1 "详细对比": 按SKU+周度展示目标数量、原始PO数量、优化后PO数量及偏差
   - Sheet 2 "汇总统计": 每个SKU的总体优化效果统计

3. **po_comparison.png** - 每周数量对比图
   - 柱状图展示: 排程目标 vs 原始PO vs 优化后PO

4. **deviation_comparison.png** - 偏差改善对比图
   - 展示每周的偏差变化和改善效果

### 程序文件

1. **po_optimization.py** - 核心优化算法
2. **visualization.py** - 可视化生成程序
3. **run_optimization.py** - 一键执行主程序

## 使用方法

### 方法1: 一键执行（推荐）

```bash
python3 run_optimization.py
```

### 方法2: 分步执行

```bash
# 步骤1: 执行优化
python3 po_optimization.py

# 步骤2: 生成可视化
python3 visualization.py
```

## 依赖安装

```bash
pip3 install pandas openpyxl matplotlib numpy
```

## 算法说明

### 优化目标

最小化目标函数:

```
Total_Deviation = Σ(weight_i × |actual_qty_i - target_qty_i|)

其中:
- weight_i = 10 (前8周)
- weight_i = 1  (第8周之后)
```

### 算法流程

1. **数据预处理**
   - 加载排程目标和PO清单
   - 生成所有有效的周一日期（排除节假日）
   - 计算每个日期对应的week_num

2. **按SKU分组优化** (并行执行)
   - 对每个SKU的PO订单列表进行优化
   - 使用贪心算法逐个分配PO订单

3. **贪心分配策略**
   - 对每个PO订单，尝试所有可能的周一日期
   - 计算分配到该日期后的总偏差
   - 选择使总偏差最小的日期
   - 偏差相同时，选择距离原日期更近的日期

4. **结果汇总**
   - 合并所有SKU的优化结果
   - 生成优化后的PO清单

### 约束条件

1. **日期范围约束**: 2025-10-01 ≤ 要货日期 ≤ 2026-06-01
2. **周一约束**: 要货日期必须为周一
3. **节假日约束**: 自动排除中国法定节假日
4. **优先级约束**: 前8周（2个月）的偏差权重为普通周的10倍

## 优化效果评估

查看 `comparison_report.xlsx` 中的"汇总统计"表格:

- **原始总偏差**: 优化前的累计绝对偏差
- **优化后总偏差**: 优化后的累计绝对偏差
- **改善百分比**: (原始总偏差 - 优化后总偏差) / 原始总偏差 × 100%

## 注意事项

1. 确保输入文件格式正确，列名与示例一致
2. 日期列必须是有效的日期格式
3. 数量列必须是数值类型
4. 优化过程可能需要几分钟，取决于SKU数量和PO订单数量
5. 建议使用多核CPU以提升并行计算速度

## 故障排查

### 问题: 模块未找到

```bash
# 安装缺失的依赖
pip3 install pandas openpyxl matplotlib numpy
```

### 问题: 日期格式错误

确保Excel中的日期列格式为日期类型，而非文本

### 问题: 优化结果不理想

- 检查排程目标是否合理
- 检查PO订单总量是否与排程目标匹配
- 调整优化参数（如优先周数、权重等）

## 技术支持

如有问题，请检查:
1. 输入文件格式是否正确
2. 依赖库是否完整安装
3. Python版本是否为3.7+

## 版本信息

- 版本: 1.0.0
- 最后更新: 2025-12-16
- Python版本要求: 3.7+

## License

本工具仅供内部使用
